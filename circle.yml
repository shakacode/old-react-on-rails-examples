general:
  artifacts:
    - todo-react/log/test.log
    - todo-react/tmp/capybara

machine:
  environment:
    RAILS_ENV: test
    RACK_ENV: test
    PATH: "${PATH}:${HOME}/${CIRCLE_PROJECT_REPONAME}/node_modules/.bin:${HOME}/.yarn/bin"
    YARN_VERSION: 0.19.1
  node:
    version: 7.4

dependencies:
  pre:
    # Install Yarn
    - |
      if [[ ! -e ~/.yarn/bin/yarn || $(yarn --version) != "${YARN_VERSION}" ]]; then
        echo "Download and install Yarn."
        curl -o- -L https://yarnpkg.com/install.sh | bash -s -- --version $YARN_VERSION
      else
        echo "The correct version of Yarn is already installed."
      fi

    # Install Google Chrome
    - wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb
    - sudo dpkg -i google-chrome*.deb
  cache_directories:
    - "~/.yarn"
    - "~/.cache/yarn"
  override:
    - yarn:
        pwd: todo-react/client
    - yarn:
        pwd: common
    - bundle check --path=vendor/bundle || bundle install --path=vendor/bundle --jobs=4 --retry=3:
        pwd: todo-react
  post:
    - yarn run build:all:rspec:
        pwd: todo-react/client

database:
  override:
    - mkdir -p todo-react/config
    - echo 'test:
        database: circle_ruby_test
        adapter: postgresql
        encoding: unicode
        pool: 5
        username: ubuntu
        host: localhost
      ' > todo-react/config/database.yml
    - bundle exec rake db:create db:schema:load --trace:
        pwd: todo-react


test:
  override:
    - bundle exec rspec --format RspecJunitFormatter --out /tmp/circle-junit.TYqO9m0/rspec/rspec.xml --format progress:
        pwd: todo-react
  post:
    - $(yarn bin)/jest .*\\.test\\.js:
        parallel: true
        environment:
          NODE_PATH: common:todo-react/client:todo-react/client/app:todo-react/client/app/bundles
          NODE_ENV: test
          JEST_JUNIT_OUTPUT: $CIRCLE_TEST_REPORTS/jest/junit.xml
    - $(yarn bin)/eslint --ext .js,.jsx:
        parallel: true
        files:
          - 'todo-react/client/app/**/*.js'
          - 'todo-react/client/app/**/*.jsx'
          - 'todo-react/client/webpack-helpers/**/*.js'
          - 'todo-react/client/server-rendering-entry.js'
          - 'todo-react/client/server.js'
          - 'todo-react/client/webpack.config.babel.js'
          - 'common/**/*.js'
    - yarn run flow:
        pwd: todo-react/client
    - yarn run flow:
        pwd: common
    - bundle exec rubocop:
        parallel: true
        # keep in sync with files in script/lint
        files:
          - 'todo-react/app/**/*.rb'
          - 'todo-react/config/**/*.rb'
          - 'todo-react/db/migrate/**/*.rb'
          - 'todo-react/db/seeders/**/*.rb'
          - 'todo-react/db/seeds.rb'
          - 'todo-react/lib/**/*.rb'
          - 'todo-react/lib/**/*.rake'
          - 'todo-react/spec/**/*.rb'
          - 'todo-react/config.ru'
          - 'todo-react/Gemfile'
          - 'todo-react/Rakefile'
    - bundle exec scss-lint:
        parallel: true
        files:
          - 'todo-react/app/assets/styles/**/*.scss'
          - 'todo-react/client/app/**/*.scss'
    - bundle exec brakeman:
        pwd: todo-react
    - bundle exec bundle-audit update && bundle exec bundle-audit:
        pwd: todo-react
